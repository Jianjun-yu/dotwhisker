#' Add a Labelled Bracket to Group Predictors in a \code{dwplot}
#'
#' @param p A plot generated by \code{dwplot}
#' @param label
#' @param top
#' @param bottom
#' @param xloc
#' @param face Options for label text: "plain", "bold", "italic", "oblique", and "bold.italic"
#'
#' @details
#'
#' @return The function returns a \code{ggplot} object.
#'
#'
#' @import grid
#'
#' @export

add_bracket <- function(p, label, top, bottom, xloc, face="italic") {
    pd <- p$data
    if (is.character(top)) top <- pd$y_ind[which(unique(pd$term)==top)]
    if (is.character(bottom)) bottom <- pd$y_ind[which(unique(pd$term)==bottom)]

    overhang <- max(pd$y_ind)/40
    x_range <- max(pd$estimate - 2*pd$std.error) - min(pd$estimate - 2*pd$std.error)
    fin_size <- x_range/25
#    label_width <- p$scales$scales[[1]]$labels
#    xloc <- min(pd$estimate - 2*pd$std.error) - label_width
    p1 <- p + theme(panel.margin = unit(c(1, 1, 1, 1.3), "lines")) +
        annotation_custom(
            grob = textGrob(label = label, gp = gpar(cex = .7, fontface = face), rot = 90),
            ymin = (top+bottom)/2, ymax = (top+bottom)/2,
            xmin = xloc-(.8*fin_size), xmax = xloc-(.8*fin_size)) +
        annotation_custom(grob = linesGrob(), xmin = xloc, xmax = xloc, ymin = bottom-overhang, ymax = top+overhang) +
        annotation_custom(grob = linesGrob(), xmin = xloc, xmax = xloc+fin_size, ymin = top+overhang, ymax = top+overhang) +
        annotation_custom(grob = linesGrob(), xmin = xloc, xmax = xloc+fin_size, ymin = bottom-overhang, ymax = bottom-overhang)

    gt <- ggplot_gtable(ggplot_build(p1)) # Code to override clipping
    gt$layout$clip[gt$layout$name == "panel"] <- "off"
    grid.draw(gt)
}

