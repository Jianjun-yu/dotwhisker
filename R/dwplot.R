#' Dot-and-Whisker Plots of Regression Coefficients from Tidy Dataframes
#'
#' \code{dwplot} is a
#'
#' @param df A model object including an interaction term, or, alternately, a data frame generated by an earlier call to interplot using the argument plot = FALSE.
#' @param varnames The name (as a string) of the variable of interest in the interaction term; its conditional coefficient estimates will be plotted.
#'
#' @details \code{dwplot} visualizes regression results saved as tidy data.frames by, e.g., \code{\link[broom]{broom::tidy}} as dot-and-whisker plots generated by \code{\link[ggplot2]{ggplot}}.
#'
#' Because the output function is based on \code{\link[ggplot2]{ggplot}}, any additional arguments and layers supported by \code{ggplot2} can be added with the \code{+}.
#'
#' @return The function returns a \code{ggplot} object.
#'
#' @import  ggplot2
#'
#' @examples
#' data(mtcars)
#' m1 <- lm(mpg ~ wt + cyl + disp, data = mtcars)
#' library(broom)
#' library(regcoefplot)
#'
#' m1_df <- tidy(m1) # create data.frame of regression results
#'
#' # Plot regression coefficients
#' dwplot(m1_df)
#'
#' @export

# Some useful keyboard shortcuts for package authoring:
#
#   Build and Reload Package:  'Cmd + Shift + B'
#   Check Package:             'Cmd + Shift + E'
#   Test Package:              'Cmd + Shift + T'

dwplot <- function(df, varnames=NULL) {

    n_vars <- length(unique(df$term))
    if ("model" %in% names(df)) n_models <- length(unique(df$model)) else {
        if (length(df$term) == n_vars) {
            df$model <- "df"
            n_models <- 1
        } else stop("Please add a variable named \'model\' to distinguish different models")
    }
    m_names <- unique(df$model)
    if (is.null(varnames)) v_names <- df$term else v_names <- rep(varnames, n_models)

    vars <- rep(seq(n_vars, 1), n_models)

    if (n_models==1) shift <- 0 else
        if (n_models==2) shift <- c(rep(.25, n_vars), rep(-.25, n_vars)) else
            if (n_model==3) shift <- c(rep(.25, n_vars), rep(0, n_vars), rep(-.25, n_vars)) else
                stop('No more than three models can be plotted at once.')

    p <- ggplot(df, aes(x = estimate, y = vars+shift, alpha=factor(model))) +
        geom_point() + theme_bw() +
        geom_segment(aes(x = estimate-qnorm(.975)*std.error, xend = estimate+qnorm(.975)*std.error,
                         y = vars+shift, yend = vars+shift,
                         alpha=factor(model))) +
        scale_alpha_discrete(range = c(0.4, 0.8)) +
        scale_y_discrete(breaks=vars, labels=v_names) +
        coord_cartesian(ylim=c(.5, n_vars+.5))

    return(p)
}
